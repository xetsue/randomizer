
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xsu Randomizer</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: monospace, monospace;
            color: #f0f0f0;
            -webkit-tap-highlight-color: transparent;
        }

        #main-randomizer-area {
        	padding-top: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
        }

        #slot-container {
            position: relative;
            width: 80vmin;
            height: 37vmin;
            background-color: #050505;
            border: 1px solid #f0f0f0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-sizing: border-box;
            overflow: hidden;
            padding: 15px;
        }

        #empty-slot-text {
            color: #333;
            font-size: 2em;
            text-align: center;
            position: absolute;
            z-index: 1;
            padding: 10px;
        }

        #slot-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            align-content: center;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #1a1a1a;
            border: 1px inset #555;
            padding: 5px;
            box-sizing: border-box;
            color: #f0f0f0;
            text-shadow: 0 0 5px #f0f0f0;
            line-height: 1.2;
            font-size: 8vmin;
        }
        
        #slot-display.long-text {
            justify-content: flex-start;
            align-items: flex-start;
            text-align: left;
        }

        .slot-word-container {
            display: inline-block;
            margin-right: 0.3em;
            white-space: nowrap;
        }

        .slot-char-container {
            display: inline-flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            line-height: 1.2;
            white-space: pre;
            text-align: center;
            padding: 0 0.1vmin;
        }

        .slot-char-current {
            position: static;
            width: auto;
        }

        @keyframes glitch-effect {
            0% { transform: translate(0); filter: hue-rotate(0deg); opacity: 1; }
            20% { transform: translate(-2px, 2px); filter: hue-rotate(90deg); opacity: 0.9; }
            40% { transform: translate(2px, -2px); filter: hue-rotate(180deg); opacity: 1; }
            60% { transform: translate(-1px, 1px); filter: hue-rotate(270deg); opacity: 0.8; }
            80% { transform: translate(1px, -1px); filter: hue-rotate(360deg); opacity: 1; }
            100% { transform: translate(0); filter: hue-rotate(0deg); opacity: 1; }
        }

        .glitching .slot-char-current {
            animation: glitch-effect 0.1s infinite alternate;
        }

        #list-history-panel {
            width: 80vmin;
            background-color: #050505ee;
            border: 1px solid #f0f0f0;
            border-radius: 5px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            min-height: 30vh;
            max-height: 50vh;
            margin-top: 35px;
        }

        #list-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            position: sticky;
            top: 0;
            background-color: #050505ee;
            z-index: 2;
        }

        #panel-toggle-button {
            background-color: transparent; border: none; color: #f0f0f0; font-size: 1.2em; cursor: pointer; font-family: monospace, monospace;
        }

        #panel-action-buttons {
            display: flex; gap: 5px;
        }

        .panel-button {
            padding: 5px 10px; background-color: transparent; border: 1px solid #f0f0f0; color: #f0f0f0; cursor: pointer; border-radius: 30px; font-family: monospace, monospace; font-size: 0.9em;
        }
        .panel-button:disabled {
            color: #555; border-color: #555; cursor: not-allowed;
        }

        #panel-content-wrapper {
            flex-grow: 1; overflow-y: auto; padding: 10px; position: relative;
        }

        #list-view-textarea {
            width: 100%; height: 100%; min-height: 100px; padding: 0; background-color: transparent; color: #f0f0f0; border: none; outline: none; resize: none; font-family: monospace, monospace; box-sizing: border-box; padding-bottom: 35px;
        }

        #start-button-in-textarea {
            position: absolute; bottom: 10px; right: 10px; padding: 5px 10px; background-color: transparent; border: 1px solid #f0f0f0; color: #f0f0f0; cursor: pointer; border-radius: 30px; font-family: monospace, monospace; font-size: 0.9em; z-index: 10;
        }

        #history-list {
            list-style: none; padding: 0; margin: 0;
        }

        #history-list li {
            padding: 5px 0; border-bottom: 1px dashed #555; display: flex; justify-content: space-between; font-size: 0.9em; cursor: pointer;
        }
        #history-list li:hover { background-color: #1a1a1a; }
        #history-list li:last-child { border-bottom: none; }

        .history-timestamp {
            font-size: 0.8em; color: #aaa; margin-left: 10px;
        }
        
        #color-toggle-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: transparent;
            border: 1px solid #f0f0f0;
            color: #f0f0f0;
            cursor: pointer;
            border-radius: 30px;
            font-family: monospace, monospace;
            font-size: 0.9em;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="main-randomizer-area">
        <div id="slot-container">
            <div id="empty-slot-text"></div>
            <div id="slot-display"></div>
        </div>
		 <p id="disappearingText" style="position: absolute; z-index:1000; top:46.5%; font-size: 10px; color: #f0f0f088;">[ Histories are saved on your device only ]</p>
        <div id="list-history-panel">
            <div id="list-history-header">
                <button id="panel-toggle-button">List â–¼</button>
                <div id="panel-action-buttons"></div>
            </div>
            <div id="panel-content-wrapper"></div>
        </div>
    </div>
    <footer style="text-align: center; margin-top: 20px; color: #555; padding: 10px;">
        <a href="https://xetsue.github.io/" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none;">xetsue.github.io</a>
    </footer>

    <script>
    setTimeout(() => {
        const text = document.getElementById('disappearingText');
        if (text) text.style.display = 'none';
    }, 3000);

    const slotContainer = document.getElementById('slot-container');
    const emptySlotText = document.getElementById('empty-slot-text');
    const slotDisplay = document.getElementById('slot-display');
    const listHistoryPanel = document.getElementById('list-history-panel');
    const panelToggleButton = document.getElementById('panel-toggle-button');
    const panelActionButtons = document.getElementById('panel-action-buttons');
    const panelContentWrapper = document.getElementById('panel-content-wrapper');

    let items = [];
    let history = [];
    let currentResult = null;
    let isAnimating = false;
    let currentPanelMode = 'list';
    let animationAbortController = null;
    let diceRollCount = 1;
    let colorRandomizationEnabled = false;
    let currentColor = '#f0f0f0';

    const glitchChars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_+=[]{}|;:',.<>/?`~";
    const diceFaces = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'];
    const coinFaces = ['Heads', 'Tails', 'Middle'];
    const colorPalette = [
        '#ff6b6b', '#4ecdc4', '#ffd166', '#6a0572', '#ff9a76',
        '#1a936f', '#114b5f', '#f9c80e', '#ea3546', '#662e9b',
        '#43bccd', '#f86624', '#2ec4b6', '#e71d36', '#ff9f1c',
        '#8ac926', '#1982c4', '#6a4c93', '#f15bb5', '#00bbf9'
    ];

    const interestingFacts = [
        "The shortest war in history was between Britain and Zanzibar on August 27, 1896. Zanzibar surrendered after 38 minutes.", 
        "A group of owls is called a parliament.",
        "Honey never spoils. Archaeologists have found pots of honey in ancient Egyptian tombs that are over 3,000 years old and still perfectly edible.",
        "There are more possible iterations of a game of chess than there are atoms in the observable universe.",
        "A single cloud can weigh more than 1 million pounds.",
        "The 'sixth sick sheik's sixth sheep's sick' is believed to be the toughest tongue twister in the English language.",
        "Polar bears have black skin under their white fur.",
        "A shrimp's heart is in its head.",
        "Octopuses have three hearts.",
        "Bananas are berries, but strawberries aren't.",
        "The Great Wall of China is not visible from space with the naked eye.",
        "Cows moo in regional accents.",
        "It takes about 8 minutes, 20 seconds for sunlight to reach Earth.",
        "Butterflies taste with their feet."
    ];
    
    const fortunes = [
        "A beautiful, smart, and loving person will be coming into your life.",
        "Your high-minded principles will bring you success.",
        "You will travel to many exotic places in your lifetime.",
        "A faithful friend is a strong defense.",
        "The world may be your oyster, but it doesn't mean you'll get its pearl.",
        "You learn from your mistakes... You will learn a lot today.",
        "If you look back, you'll soon be going that way.",
        "You will be hungry again in one hour.",
        "The fortune you seek is in another cookie.",
        "A closed mouth gathers no feet.",
        "A conclusion is simply the place where you got tired of thinking.",
        "A foolish man listens to his heart. A wise man listens to cookies.",
        "No, don't.",
        "Help! I am being held prisoner in a Chinese bakery.",
        "The early bird gets the worm, but the second mouse gets the cheese.",
        "Your road to glory will be rocky, but will reflect true beauty.",
        "About time I got out of that cookie.",
        "You will be surprised by a loud noise.",
        "You will discover a hidden talent.",
        "A smile is your passport into the hearts of others.",
        "Your creativity will lead to great opportunities this week.",
        "Good things come to those who wait, but better things come to those who act.",
        "A pleasant surprise is waiting for you around the corner.",
        "Your kindness will be rewarded in unexpected ways.",
        "The best way to predict the future is to create it.",
        "Your hard work will soon pay off in a big way.",
        "A new friendship will bring you joy and inspiration.",
        "Trust your intuitionâ€”it's rarely wrong.",
        "Success is not final, failure is not fatal: it is the courage to continue that counts.",
        "The only limit to your impact is your imagination and commitment.",
        "You will soon receive good news from an unexpected source.",
        "Your positive attitude will lead to positive outcomes.",
        "A chance meeting will open new doors for you.",
        "Your talents will be recognized and rewarded.",
        "The greatest risk is not taking one.",
        "Your persistence will overcome all obstacles.",
        "A dream you've been holding onto will soon become reality.",
        "Your generosity will come back to you multiplied.",
        "Do it.",
        "You know what you need already.",
        "Consider Violence , simply consider.",
        "No there won't be any consequences",
        "The solution to your problem will appear when you least expect it.",
        "You are on the verge of a major breakthrough."
    ];

    function saveState() {
        localStorage.setItem('xsuRandomizerItems', JSON.stringify(items));
        localStorage.setItem('xsuRandomizerHistory', JSON.stringify(history));
        localStorage.setItem('xsuRandomizerDiceCount', diceRollCount.toString());
        localStorage.setItem('xsuColorRandomization', colorRandomizationEnabled.toString());
    }

    function loadState() {
        items = JSON.parse(localStorage.getItem('xsuRandomizerItems') || '[]');
        history = JSON.parse(localStorage.getItem('xsuRandomizerHistory') || '[]');
        diceRollCount = parseInt(localStorage.getItem('xsuRandomizerDiceCount') || '1', 10);
        colorRandomizationEnabled = localStorage.getItem('xsuColorRandomization') === 'true';
    }
    
    function adjustFontSize(container) {
        if (!container.firstChild) return;
        container.style.fontSize = '8vmin';
        let currentFontSize = 8;
        const minFontSize = 1;
        while ((container.scrollHeight > container.clientHeight || container.scrollWidth > container.clientWidth) && currentFontSize > minFontSize) {
            currentFontSize -= 0.2;
            container.style.fontSize = `${currentFontSize}vmin`;
        }
    }

    function renderSlotDisplay(displayContent, isLongText = false, isDiceDisplay = false) {
        slotDisplay.innerHTML = '';
        emptySlotText.style.display = 'none';
        slotDisplay.className = 'slot-display';
        if (isLongText) slotDisplay.classList.add('long-text');

        if (isDiceDisplay) {
            const dice = displayContent.split(' ');
            dice.forEach(dieChar => {
                const charContainer = document.createElement('div');
                charContainer.classList.add('slot-char-container');
                const charSpan = document.createElement('span');
                charSpan.classList.add('slot-char-current');
                charSpan.textContent = dieChar;
                charContainer.appendChild(charSpan);
                
                slotDisplay.appendChild(charContainer);
            });
        } else if (typeof displayContent === 'string') {
            const words = displayContent.split(' ');
            words.forEach((word, wordIndex) => {
                const wordContainer = document.createElement('div');
                wordContainer.classList.add('slot-word-container');
                
                for (const char of word) {
                    const charContainer = document.createElement('div');
                    charContainer.classList.add('slot-char-container');
                    const charSpan = document.createElement('span');
                    charSpan.classList.add('slot-char-current');
                    charSpan.textContent = char;
                    charContainer.appendChild(charSpan);
                    wordContainer.appendChild(charContainer);
                }
                
                if (wordIndex < words.length - 1) {
                    const spaceContainer = document.createElement('div');
                    spaceContainer.classList.add('slot-char-container');
                    const spaceSpan = document.createElement('span');
                    spaceSpan.classList.add('slot-char-current');
                    spaceSpan.textContent = ' ';
                    spaceContainer.appendChild(spaceSpan);
                    wordContainer.appendChild(spaceContainer);
                }
                
                slotDisplay.appendChild(wordContainer);
            });
        }

        if (items.length === 0 && !displayContent) {
            emptySlotText.textContent = "";
            emptySlotText.style.display = 'block';
        }
        adjustFontSize(slotDisplay);
    }

    function renderPanel() {
        panelActionButtons.innerHTML = '';
        panelContentWrapper.innerHTML = '';

        if (currentPanelMode === 'list') {
            panelToggleButton.textContent = 'List â–¼';

            const resetBtn = document.createElement('button');
            resetBtn.classList.add('panel-button');
            resetBtn.textContent = 'Reset';
            resetBtn.addEventListener('click', (e) => { e.stopPropagation(); resetAllData(); });
            panelActionButtons.appendChild(resetBtn);
            
            const fortuneBtn = document.createElement('button');
            fortuneBtn.classList.add('panel-button');
            fortuneBtn.textContent = 'ðŸ¥ ';
            fortuneBtn.addEventListener('click', (e) => { e.stopPropagation(); startAnimation({ forceFortune: true }); });
            panelActionButtons.appendChild(fortuneBtn);

            const flipBtn = document.createElement('button');
            flipBtn.classList.add('panel-button');
            flipBtn.textContent = 'ðŸª™';
            flipBtn.addEventListener('click', (e) => { e.stopPropagation(); startAnimation({ forceFlip: true }); });
            panelActionButtons.appendChild(flipBtn);
            
            const diceBtn = document.createElement('button');
            diceBtn.classList.add('panel-button');
            diceBtn.textContent = 'ðŸŽ²';
            diceBtn.addEventListener('click', (e) => { e.stopPropagation(); startDiceAnimation(diceRollCount); });
            panelActionButtons.appendChild(diceBtn);

            const textarea = document.createElement('textarea');
            textarea.id = 'list-view-textarea';
            textarea.value = items.join('\n');
            textarea.placeholder = "Tap Any Empty Space\nto start/stop rolling\n\nEnter items, one per line...\n\n1..\n\n2..\n\n3..";
            panelContentWrapper.appendChild(textarea);

            const startButtonInTextarea = document.createElement('button');
            startButtonInTextarea.id = 'start-button-in-textarea';
            startButtonInTextarea.textContent = 'Start';
            startButtonInTextarea.addEventListener('click', (e) => {
                e.stopPropagation();
                saveListFromTextarea();
                startAnimation();
            });
            panelContentWrapper.appendChild(startButtonInTextarea);

        } else {
            panelToggleButton.textContent = 'History';

            const removeResultBtn = document.createElement('button');
            removeResultBtn.classList.add('panel-button');
            removeResultBtn.textContent = 'Remove Last';
            removeResultBtn.title = "Remove the last result from the main list";
            removeResultBtn.addEventListener('click', (e) => { e.stopPropagation(); removeItemFromResultList(); });
            if (!currentResult || items.indexOf(currentResult) === -1) removeResultBtn.disabled = true;
            panelActionButtons.appendChild(removeResultBtn);

            const editBtn = document.createElement('button');
            editBtn.classList.add('panel-button');
            editBtn.textContent = 'Edit List';
            editBtn.addEventListener('click', (e) => { e.stopPropagation(); currentPanelMode = 'list'; renderPanel(); });
            panelActionButtons.appendChild(editBtn);

            const ul = document.createElement('ul');
            ul.id = 'history-list';
            [...history].reverse().forEach(entry => {
                const li = document.createElement('li');
                const textSpan = document.createElement('span');
                textSpan.textContent = entry.item;
                const timestampSpan = document.createElement('span');
                timestampSpan.classList.add('history-timestamp');
                timestampSpan.textContent = new Date(entry.timestamp).toLocaleString();
                
                li.appendChild(textSpan);
                li.appendChild(timestampSpan);
                li.addEventListener('click', () => handleHistoryItemClick(entry));
                ul.appendChild(li);
            });

            panelContentWrapper.appendChild(ul);
            
            const colorToggleBtn = document.createElement('button');
            colorToggleBtn.id = 'color-toggle-button';
            colorToggleBtn.textContent = colorRandomizationEnabled ? 'Color: ON' : 'Color: OFF';
            colorToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                colorRandomizationEnabled = !colorRandomizationEnabled;
                saveState();
                colorToggleBtn.textContent = colorRandomizationEnabled ? 'Color: ON' : 'Color: OFF';
            });
            panelContentWrapper.appendChild(colorToggleBtn);
        }
    }

    function saveListFromTextarea() {
        const textarea = document.getElementById('list-view-textarea');
        if (textarea) {
            items = textarea.value.split('\n').map(item => item.trim()).filter(Boolean);
            saveState();
            renderSlotDisplay(items.length > 0 ? items[0] : null);
        }
    }
    
    function handleHistoryItemClick(entry) {
        if (isAnimating) return;
        if (confirm(`Delete this history entry?\n\n"${entry.item}"`)) {
            history = history.filter(h => h.timestamp !== entry.timestamp);
            saveState();
            renderPanel();
        } else if (confirm("Clear ALL history? (This will not affect your item list).")) {
            history = [];
            saveState();
            renderPanel();
        }
    }

    function removeItemFromResultList() {
        if (!currentResult) { alert('No result has been generated yet.'); return; }
        const itemIndex = items.indexOf(currentResult);
        if (itemIndex > -1) {
            if (confirm(`Are you sure you want to remove "${currentResult}" from your list?`)) {
                items.splice(itemIndex, 1);
                saveState();
                alert(`"${currentResult}" has been removed from the list.`);
                renderPanel();
            }
        } else {
            alert(`The last result ("${currentResult}") is not from your list.`);
        }
    }

    function resetAllData() {
        if (confirm('Are you sure you want to reset ALL data? This will clear your item list and all history.')) {
            items = [];
            history = [];
            currentResult = null;
            diceRollCount = 1;
            colorRandomizationEnabled = true;
            localStorage.clear();
            renderSlotDisplay("Xsu.", false);
            currentPanelMode = 'list';
            renderPanel();
            alert('All data has been reset.');
        }
    }
    
    function skipCurrentAnimation() {
        if (isAnimating && animationAbortController) {
            animationAbortController.abort();
        }
    }

    function getRandomColor() {
        return colorPalette[Math.floor(Math.random() * colorPalette.length)];
    }

    async function startAnimation(options = {}) {
        if (isAnimating) return;

        let itemToDisplay;
        let isLongText = false;
        let fromList = false;
        let type = 'list';

        if (options.forceFlip) {
            const r = Math.random();
            itemToDisplay = r < 0.01 ? "Middle" : (r < 0.505 ? "Heads" : "Tails");
            type = 'flip';
        } else if (options.forceFortune) {
            itemToDisplay = fortunes[Math.floor(Math.random() * fortunes.length)];
            isLongText = true;
            type = 'fortune';
        } else if (items.length === 0) {
            itemToDisplay = interestingFacts[Math.floor(Math.random() * interestingFacts.length)];
            isLongText = true;
            type = 'fact';
        } else {
            itemToDisplay = items[Math.floor(Math.random() * items.length)];
            isLongText = itemToDisplay.length > 20;
            fromList = true;
        }
        
        currentResult = itemToDisplay;
        isAnimating = true;
        animationAbortController = new AbortController();
        const { signal } = animationAbortController;

        if (colorRandomizationEnabled) {
            currentColor = getRandomColor();
            slotDisplay.style.color = currentColor;
            slotDisplay.style.textShadow = `0 0 5px ${currentColor}`;
        } else {
            slotDisplay.style.color = '#f0f0f0';
            slotDisplay.style.textShadow = '0 0 5px #f0f0f0';
        }

        slotContainer.style.cursor = 'not-allowed';
        document.body.style.cursor = 'not-allowed';

        if (fromList && items.length > 0) {
            let cycles = 0;
            const maxCycles = 40 + Math.floor(Math.random() * 10);
            const cycleInterval = 25;

            while (cycles < maxCycles) {
                if (signal.aborted) break;
                const randomItem = items[Math.floor(Math.random() * items.length)];
                renderSlotDisplay(randomItem, randomItem.length > 20);
                await new Promise(resolve => setTimeout(resolve, cycleInterval));
                cycles++;
            }
        }

        renderSlotDisplay(itemToDisplay, isLongText);
        const charSpans = Array.from(slotDisplay.querySelectorAll('.slot-char-current'));
        charSpans.forEach(span => span.parentElement.classList.add('glitching'));
        
        const scrambleIntervals = charSpans.map(span => {
            return setInterval(() => {
                span.textContent = glitchChars[Math.floor(Math.random() * glitchChars.length)];
            }, 50);
        });

        const cleanup = () => {
            scrambleIntervals.forEach(clearInterval);
            charSpans.forEach((span, i) => {
                span.parentElement.classList.remove('glitching');
                span.textContent = itemToDisplay[i] || ' ';
            });
            adjustFontSize(slotDisplay);
            if (fromList || type === 'fortune' || type === 'fact' || type === 'flip') {
                history.push({ item: itemToDisplay, timestamp: new Date().toISOString() });
                saveState();
            }
            if (fromList) {
                currentPanelMode = 'history';
            }
            renderPanel();
            isAnimating = false;
            animationAbortController = null;
            slotContainer.style.cursor = 'pointer';
            document.body.style.cursor = 'default';
        };

        try {
            await new Promise((resolve, reject) => {
                const timeoutId = setTimeout(resolve, 1000);
                signal.addEventListener('abort', () => { clearTimeout(timeoutId); reject(); });
            });

            for (let i = 0; i < charSpans.length; i++) {
                if (signal.aborted) break;
                clearInterval(scrambleIntervals[i]);
                charSpans[i].parentElement.classList.remove('glitching');
                charSpans[i].textContent = itemToDisplay[i] || ' ';
                await new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(resolve, 50);
                    signal.addEventListener('abort', () => { clearTimeout(timeoutId); reject(); });
                });
            }
        } catch (e) {
        } finally {
            cleanup();
        }
    }
    
    async function startDiceAnimation(count) {
        if (count <= 0 || count > 50) {
            alert("Please enter a number between 1 and 50.");
            isAnimating = false;
            slotContainer.style.cursor = 'pointer';
            document.body.style.cursor = 'default';
            return;
        }
        
        diceRollCount = count;
        saveState();
        
        isAnimating = true;
        animationAbortController = new AbortController();
        const { signal } = animationAbortController;

        if (colorRandomizationEnabled) {
            currentColor = getRandomColor();
            slotDisplay.style.color = currentColor;
            slotDisplay.style.textShadow = `0 0 5px ${currentColor}`;
        } else {
            slotDisplay.style.color = '#f0f0f0';
            slotDisplay.style.textShadow = '0 0 5px #f0f0f0';
        }

        slotContainer.style.cursor = 'not-allowed';
        document.body.style.cursor = 'not-allowed';
        
        let finalDiceResult = Array.from({length: count}, () => diceFaces[Math.floor(Math.random() * diceFaces.length)]).join(' ');
        currentResult = finalDiceResult;
        
        renderSlotDisplay(finalDiceResult, false, true);
        
        const charSpans = Array.from(slotDisplay.querySelectorAll('.slot-char-current'));
        charSpans.forEach(span => span.parentElement.classList.add('glitching'));
        
        const scrambleIntervals = charSpans.map(span => {
            return setInterval(() => {
                span.textContent = diceFaces[Math.floor(Math.random() * diceFaces.length)];
            }, 50);
        });

        const cleanup = () => {
            scrambleIntervals.forEach(clearInterval);
            const finalDiceCharacters = finalDiceResult.split(' ');
            charSpans.forEach((span, i) => {
                span.parentElement.classList.remove('glitching');
                span.textContent = finalDiceCharacters[i] || ' ';
            });
            adjustFontSize(slotDisplay);
            history.push({ item: finalDiceResult, timestamp: new Date().toISOString(), type: 'dice' });
            saveState();
            renderPanel();
            isAnimating = false;
            animationAbortController = null;
            slotContainer.style.cursor = 'pointer';
            document.body.style.cursor = 'default';
        };

        try {
            await new Promise((resolve, reject) => {
                const timeoutId = setTimeout(resolve, 1500);
                signal.addEventListener('abort', () => { clearTimeout(timeoutId); reject(); });
            });

            for (let i = 0; i < charSpans.length; i++) {
                if (signal.aborted) break;
                clearInterval(scrambleIntervals[i]);
                charSpans[i].parentElement.classList.remove('glitching');
                const finalDiceCharacters = finalDiceResult.split(' ');
                charSpans[i].textContent = finalDiceCharacters[i] || ' ';
                await new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(resolve, 50);
                    signal.addEventListener('abort', () => { clearTimeout(timeoutId); reject(); });
                });
            }
        } catch(e) {
        } finally {
            cleanup();
        }
    }

    slotContainer.addEventListener('click', () => {
        if (isAnimating) {
            skipCurrentAnimation();
            return;
        }
        const currentDisplayedText = Array.from(slotDisplay.querySelectorAll('.slot-char-current')).map(s => s.textContent).join('');
        const isCurrentDisplayDice = diceFaces.some(face => currentDisplayedText.includes(face));

        if (isCurrentDisplayDice) {
            const numDice = prompt("How many dice to roll at once? (1-50)", diceRollCount.toString());
            if (numDice !== null) {
                const parsedNumDice = parseInt(numDice, 10);
                if (!isNaN(parsedNumDice) && parsedNumDice >= 1 && parsedNumDice <= 50) {
                    startDiceAnimation(parsedNumDice);
                } else {
                    alert("Please enter a number between 1 and 50.");
                }
            }
            return;
        }
        startAnimation();
    });
    
    document.body.addEventListener('click', (event) => {
        if (listHistoryPanel.contains(event.target) || slotContainer.contains(event.target)) {
            return;
        }
        if (isAnimating) {
            skipCurrentAnimation();
        } else {
            if (currentPanelMode === 'list') saveListFromTextarea();
            startAnimation();
        }
    });

    panelToggleButton.addEventListener('click', (e) => {
        e.stopPropagation();
        currentPanelMode = currentPanelMode === 'list' ? 'history' : 'list';
        if(currentPanelMode === 'list' && document.getElementById('list-view-textarea')) {
            saveListFromTextarea();
        }
        renderPanel();
    });

    document.addEventListener('keydown', (event) => {
        if (event.code === 'Space' && document.activeElement.tagName !== 'TEXTAREA') {
            event.preventDefault();
            if(isAnimating) skipCurrentAnimation();
            else startAnimation();
        }
    });

    loadState();
    if (items.length > 0) {
        renderSlotDisplay(items[0], items[0].length > 20);
    } else {
        renderSlotDisplay("Xsu.", false);
        currentPanelMode = 'list';
    }
    renderPanel();
    </script>
</body>
</html>
